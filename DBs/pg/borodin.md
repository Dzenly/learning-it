http://www.youtube.com/watch?v=ejLzS6rVpkk

Прикольно замутнять части слайда, про которые
сейчас не говоришь.

postmaster - простая, не блокируется,почти не трогает
разделяемую память.

Есть API для работы с диском.
Пока есть одна имплементацию.

БД - отдельная папка.
Гигабайтные файлы данных, разбитые на 8кб страницы.


xlog buffers - очень осторожно.
Можно потерять данные, хоть и поднимешь производительность
IO.

Синтаксический парсер
(Parse tree)
Semantic parser.
(Query tree)
Rewriter (заменяет представления таблицами, кастомные правила).
Оптимизатор.

pg_catalog инфа о таблицах, пользователях, статистика.

Процесс checkpointer.

WAL локи чистятся.
До предыдущего (не текущего!) чекпоинта.

Startup process - восстанавивает базу и завршается.

MVCC работает через номера транзакций на таплах.

Автовакуум - собирает статистику по таблице, 
кол-во строчек и распределение значений.
Так что не надо выключать автовакуум.

vacuum full - глубокая чистка системы.

Переинициализация базы после смены значений при компиляции.

Ещё вакуум двигает мин номер транзакций (xmin, xmax).

Bgwriter - пишет старые страницы из шаред буферов на диск.

--------

Эти процессы не трогают разделяемую память:

WAL archiver записанные XLog в архив.
Это может быть другая машина.

Statc Collector (UDP)

WAL sender/receiver

Logging collector (UDP)


--------

Custom bgworker. - Кастомная обработка разных событий.
Он имеет доступ к shared memory.

==============

postgres = backend.

Rel cache - в локальной памяти процесса (код хранимых процедур).
plan cache.
catalog cache.
temp buffers
work mem

pg_bouncer - 6432.
(из команды Skype)

===========
---
Shared memory:
procArray управление блокировками.
Locks Info

CLog buffers - текущие состояния транзакций.

Subtrans buffers - Save point транзакций. Ролбэк откатит до сейв поинта.


Two-phase коммиты. Мульти транзакции.

===========

?? Проследить, чтобы соединение не разрывалось после запросов.
Подъем соединения - тяжелая операция.

================

====================================


Можно ли запросами управлять всякими fsync и WAl синком, вакуумом, и т.д.
В общем, операциями с дисками.

Есть механизмы, гарантирующие целостность, даже если хардваре глючит..
Например чексуммы.


ПГ в большинстве случаев упирается в IO.
Оракл - в процессор.


Все объекты.
ПГ - ООБД.



================

# Типы данных

* Стандартные
* Геометрические (точки, линии, боксы, пути, полигоны...)
* Сетевые адреса (inet, cidr, macadr)
* UUID
* JSON / JSONB 
* Композитные
* Range
* ARRAY
* Битовые строки
* Текстовый поиск
* ISBN
* XML
* HSTORE (и др. расширения).
* Custom types


Для процедур поддерживаются 
psSQL, Tcl, Perl, Python (и можно подключить кучу других).

===========

Индексы:

Типы:

* Compound
* Unique
* Partial
* Functional

Индексы:

* GIN
* PostGIS (Яндекс карты, Open Street Map)
* OpenFTS (Full Text Search) T.e. Lucene не нужен.
* BRIN (since 9.5) ?? (Вид B-tree, позволяющий кое где ускорять обход дерева)

Access methods:

* B-tree
* R-tree
* Hash
* GIST (Гео данные)
* SP-GIST (разряженные GIST)
* GIN
* VODKA (since 9.5)

================

Foreign data wrappers.

====================

# contrib - расширения, поддерживаемые комьюнити.

* pg_stat_statements - статистика.

* pg_buffercache - инфа о буферах.
* pg_prewarm - for shared buffers
* pgbench - performance testing
* pg_upgrade - для апгрейда между мажорными версиями.
* autoexplain - логи экспейна для долгих запросов.
* pg_crypto -
* pg_rewind -

Наследование таблиц.
(пока не очень совершенна)

Event (LISTEN/NOTIFY).



View (представление) - склейка таблиц.
Материализованные представления (типа кэш данных).
Скорее для медленных вещей. В реал тайме не стоит.

Окна для аггрегатных функций?


В сорцах PG есть readme файлы. Хорошее дополнение к документации.

d0uble@yandex-team.ru

===============================================
===============================================
===============================================

http://www.youtube.com/watch?v=cqyloVzIZqM

Тема про бэкапы.

Бэкапы - очень нужны.
Можно спасаться отстающими репликами.

Можно повредить случайно.
Можно из за багов железа и самого ПГ.

pg_control инфа о состоянии транзакций.

=========

Резервное копирование.

pg_start_backup('foo') // Только на мастере. 
pg_basebackup.
pg_dump - не очень.

?? Что такое tablespaces ??

НОрмально делать бэкапы на горячую.

Нет инкрементальных бэкапов ??
Нет пока сжатия с параллелизмом.

Эти бэкапы делаются на файловом уровне, и могут повредиться.
Закон Мерфи.
В новых ПГ появились чексуммы.

Barman - помогает бэкапиться.

Можно настраивать скорость IO.

В двухфазных коммитах с бэкапами восстанавливаются локи.

full page writes - убедись, что включен.


CRC32 для записи в WAL.


Barman check all.









