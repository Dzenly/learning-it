https://www.postgresql.org/docs/11/backup-dump.html

# pg_dump dbname > dumpfile

Генерирует sql команды, которые пересоздают бд в том же состоянии, которое
было на момент дампа.

Чтобы бэкапнуть все базу, нужно запускать от суперюзера.

?? Что если накатить на уже существующую базу?
--clean (очистит таблицы, указанные в бэкапе) --exit-on-error

?? Почему пишут, что pg_dump делает снапшот на момент запуска.
?? Чем отличается pg_dump dbname от pg_dump -d dbname

?? Почему именно template0? Что такое вообще темплейты.
?? Что такое tablespaces
?? Что такое roles
?? Что если БД восстанавливать в докере?
М.б. будет кучка докер образов для бд?
Нам же надо чтобы оно максимально быстро рестартовало.
Почитать про хранение БД в докере.
Что такое CHECKPOINT.
?? М.б. можно создать темплейт, и на него только данные накатывать.

===========

Самое главное - параллельные запуски, обсудить насколько они нужны.
Если все лимитируется БД или памятью машины.
Надо выбирать тесты, не влияющие друг на друга.




=========



Поревьюить в каком состоянии пресеты БД.
Много ли русских сущностей осталось.




===========




Он не блокирует другие операции, кроме операций, требующих эксклюзивные локи (типа alter table).

## restoring

psql --single-transaction --set ON_ERROR_STOP=on имя_базы < входной_файл

Не создает dbname
Базу нужно создать самому от template0 createdb -T template0 dbname

Перед рестором все юзеры владельцы и доступатели - должны существовать.

По умолчанию psql не останавливается при ошибках.

psql --set ON_ERROR_STOP

Перекинуть базу с одного сервера, на другой:
`pg_dump -h host1 dbname | psql -h host2 dbname`

После restoring хорошо бы сделать ANALYZE.

=================

# pg_dumpall - дам

pg_dumpall > dumpfile
Создает команды для пересоздания ролей, спейсов, пустых БД,
А потом делает pg_dump для каждой БД.
Т.е. получается снапшот баз не на момент вызова pg_dumpall, а с небольшим рассинхроном.

psql -f dumpfile postgres

--globals-only
===============

# File System Level backup.

* Нужно гасить кластер перед дампом и перед рестором.
Иногда операционка поддерживает снапшоты, но если снимаешь снапшот,
это выглядит для PG, как некорректный shutdown. Это не проблема.

Можно как-то прикрутить сюда rsync.

Такие бэкапы больше, но работают быстрее.

========

































https://postgrespro.ru/docs/postgrespro/10/backup-dump

pg_dump basename > outfile

-n - схема.
-t таблица.

Нужен read доступ на все, что хочу выгрузить.

PGHOST, PGPORT, PGUSER (-U)


pg_dump сохраняет данные в совместимом между версиями формате.

Не блокирует неисключительные блокировки.


----

psql basename < infile

База и все нужные пользователи должны существовать.

Например из template0.

?? Как забэкапить пользователей ??






Важно. дамп делается относительно template0.


После восстановления полезно запустить ANALYZE.












https://www.youtube.com/watch?v=kH3XKCbwsHU

https://www.postgresql.org/docs/9.5/static/backup-dump.html

Крон запускает скрипт.

Скрипт:
* Копирует в определенную папку нужные файлы из списка.
* Делает дамп базы данных.

===============

